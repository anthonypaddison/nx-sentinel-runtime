# config/packages/nx_sentinel_watchtower.yaml
############################
# NX-SENTINEL-WATCHTOWER - SENSORS
############################

binary_sensor:
    # nx-bastion health endpoint (plain text "Healthy" expected)
    - platform: rest
      name: nx-bastion VPN Health
      unique_id: nx_sentinel_watchtower_nx_bastion_vpn_health
      device_class: connectivity
      resource: !secret gluetun_health_url
      timeout: 5
      scan_interval: 15
      value_template: >-
          {{ 'healthy' in (value | default('') | lower) }}

    # Port checks (LAN bindings)
    - platform: tcp
      name: nx-transmit Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 15
      port: 8080

    - platform: tcp
      name: nx-beacon-sonar Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
      port: 8989

    - platform: tcp
      name: nx-beacon-radar Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
      port: 7878

    - platform: tcp
      name: nx-beacon-prowlarr Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
      port: 9696

    - platform: tcp
      name: nx-spectrum Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
      port: 8096

    - platform: tcp
      name: nx-observer Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
      port: 5055

    - platform: tcp
      name: nx-watchtower Port
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
      port: 3001

############################
# NX-SENTINEL-WATCHTOWER - ARR SENSORS
############################
# Requires secrets: sonarr_api_key, radarr_api_key, and the URL secrets below.

sensor:
    # -------- nx-beacon-sonar --------
    - platform: rest
      method: GET
      timeout: 8
      headers:
          X-Api-Key: !secret sonarr_api_key
      value_template: >-
          {{ value_json.totalRecords | default(0) | int }}
      name: nx-beacon-sonar Queue Count
      unique_id: nx_sentinel_watchtower_nx_beacon_sonar_queue_count
      resource: !secret sonarr_queue_url
      scan_interval: 300

    - platform: rest
      method: GET
      timeout: 8
      headers:
          X-Api-Key: !secret sonarr_api_key
      value_template: >-
          {{ value_json.totalRecords | default(0) | int }}
      name: nx-beacon-sonar Missing Episodes
      unique_id: nx_sentinel_watchtower_nx_beacon_sonar_missing_episodes
      resource: !secret sonarr_missing_url
      scan_interval: 900

    - platform: rest
      method: GET
      timeout: 8
      headers:
          X-Api-Key: !secret sonarr_api_key
      value_template: >-
          {{ value_json.totalRecords | default(0) | int }}
      name: nx-beacon-sonar Cutoff Unmet
      unique_id: nx_sentinel_watchtower_nx_beacon_sonar_cutoff_unmet
      resource: !secret sonarr_cutoff_url
      scan_interval: 1800

    # -------- nx-beacon-radar --------
    - platform: rest
      method: GET
      timeout: 8
      headers:
          X-Api-Key: !secret radarr_api_key
      value_template: >-
          {{ value_json.totalRecords | default(0) | int }}
      name: nx-beacon-radar Queue Count
      unique_id: nx_sentinel_watchtower_nx_beacon_radar_queue_count
      resource: !secret radarr_queue_url
      scan_interval: 300

    - platform: rest
      method: GET
      timeout: 8
      headers:
          X-Api-Key: !secret radarr_api_key
      value_template: >-
          {{ value_json.totalRecords | default(0) | int }}
      name: nx-beacon-radar Missing Movies
      unique_id: nx_sentinel_watchtower_nx_beacon_radar_missing_movies
      resource: !secret radarr_missing_url
      scan_interval: 1800

############################
# NX-SENTINEL-WATCHTOWER - DISK FREE (via SSH)
############################
# Requires secret: media_box_ssh_target in /config/secrets.yaml
# (example: "user@192.168.1.154").

command_line:
    - sensor:
          name: Downloads Free GB
          unique_id: nx_sentinel_watchtower_downloads_free_gb
          unit_of_measurement: 'GB'
          scan_interval: 300
          value_template: '{{ value | int(0) }}'
          command: >-
              bash /config/scripts/disk_free.sh
              /srv/downloads

    - sensor:
          name: Media Free GB
          unique_id: nx_sentinel_watchtower_media_free_gb
          unit_of_measurement: 'GB'
          scan_interval: 300
          value_template: '{{ value | int(0) }}'
          command: >-
              bash /config/scripts/disk_free.sh
              /srv/media

############################
# NX-SENTINEL-WATCHTOWER - ALERT THRESHOLDS
############################

input_number:
    downloads_free_gb_warn:
        name: Downloads Free GB Warn
        min: 0
        max: 5000
        step: 1
        unit_of_measurement: 'GB'
        initial: 50

    media_free_gb_warn:
        name: Media Free GB Warn
        min: 0
        max: 5000
        step: 1
        unit_of_measurement: 'GB'
        initial: 100

############################
# NX-SENTINEL-WATCHTOWER - AUTOMATIONS
############################

automation:
    - id: nx_sentinel_watchtower_nx_bastion_down
      alias: nx-sentinel-watchtower - nx-bastion Down
      mode: single
      trigger:
          - platform: state
            entity_id: binary_sensor.nx_bastion_vpn_health
            to:
                - 'off'
                - 'unavailable'
                - 'unknown'
            for:
                minutes: 2
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸ”´ **NX-BASTION VPN DOWN**
                    Docker outbound blocked (kill-switch active).
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

    - id: nx_sentinel_watchtower_nx_bastion_restored
      alias: nx-sentinel-watchtower - nx-bastion Restored
      mode: single
      trigger:
          - platform: state
            entity_id: binary_sensor.nx_bastion_vpn_health
            to: 'on'
            for:
                seconds: 30
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸŸ¢ **NX-BASTION VPN UP**
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

    - &queue_stuck_template
      id: nx_sentinel_watchtower_nx_beacon_sonar_queue_stuck
      alias: nx-sentinel-watchtower - nx-beacon-sonar Queue Stuck
      mode: single
      trigger:
          - platform: numeric_state
            entity_id: sensor.nx_beacon_sonar_queue_count
            above: 0
            for:
                minutes: 60
      action:
          - service: script.nx_sentinel_watchtower_queue_stuck_notify
            data:
                service_name: nx-beacon-sonar
                queue_sensor: sensor.nx_beacon_sonar_queue_count
                missing_sensor: sensor.nx_beacon_sonar_missing_episodes

    - <<: *queue_stuck_template
      id: nx_sentinel_watchtower_nx_beacon_radar_queue_stuck
      alias: nx-sentinel-watchtower - nx-beacon-radar Queue Stuck
      trigger:
          - platform: numeric_state
            entity_id: sensor.nx_beacon_radar_queue_count
            above: 0
            for:
                minutes: 60
      action:
          - service: script.nx_sentinel_watchtower_queue_stuck_notify
            data:
                service_name: nx-beacon-radar
                queue_sensor: sensor.nx_beacon_radar_queue_count
                missing_sensor: sensor.nx_beacon_radar_missing_movies

    - id: nx_sentinel_watchtower_downloads_low_disk
      alias: nx-sentinel-watchtower - Downloads Low Disk
      mode: single
      trigger:
          - platform: template
            value_template: >-
                {{ states('sensor.downloads_free_gb')|int(0) > 0 and
                   states('sensor.downloads_free_gb')|int(0) <= states('input_number.downloads_free_gb_warn')|int(0) }}
            for:
                minutes: 10
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸ”´ **LOW DISK: /srv/downloads**
                    Free: {{ states('sensor.downloads_free_gb') }} GB
                    Threshold: {{ states('input_number.downloads_free_gb_warn') }} GB
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

    - id: nx_sentinel_watchtower_media_low_disk
      alias: nx-sentinel-watchtower - Media Low Disk
      mode: single
      trigger:
          - platform: template
            value_template: >-
                {{ states('sensor.media_free_gb')|int(0) > 0 and
                   states('sensor.media_free_gb')|int(0) <= states('input_number.media_free_gb_warn')|int(0) }}
            for:
                minutes: 10
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸ”´ **LOW DISK: /srv/media**
                    Free: {{ states('sensor.media_free_gb') }} GB
                    Threshold: {{ states('input_number.media_free_gb_warn') }} GB
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

script:
    nx_sentinel_watchtower_queue_stuck_notify:
        alias: nx-sentinel-watchtower - Queue Stuck Notify
        mode: queued
        fields:
            service_name:
                description: Service label for the message header.
            queue_sensor:
                description: Sensor entity_id for queue length.
            missing_sensor:
                description: Sensor entity_id for missing items.
        sequence:
            - service: notify.home_infra_alerts_anthony_paddison_8006541880
              data:
                  message: |-
                      ðŸŸ  **{{ service_name | upper }} QUEUE STUCK**
                      Queue: {{ states(queue_sensor) }}
                      Missing: {{ states(missing_sensor) }}
                      {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
