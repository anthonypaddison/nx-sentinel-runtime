# config/packages/home_infra.yaml
############################
# HOME INFRA - SENSORS
############################

binary_sensor:
    - &tcp_defaults
      platform: tcp
      host: !secret media_host_ip
      payload: ''
      timeout: 3
      scan_interval: 30
    # Gluetun health endpoint (plain text "Healthy" expected)
    - platform: rest
      name: Gluetun VPN Health
      unique_id: home_infra_gluetun_vpn_health
      device_class: connectivity
      resource: !secret gluetun_health_url
      timeout: 5
      scan_interval: 15
      value_template: >-
          {{ 'healthy' in (value | default('') | lower) }}

    # Port checks (LAN bindings)
    - <<: *tcp_defaults
      name: qBittorrent WebUI Port
      port: 8080
      scan_interval: 15

    - <<: *tcp_defaults
      name: Sonarr Port
      port: 8989

    - <<: *tcp_defaults
      name: Radarr Port
      port: 7878

    - <<: *tcp_defaults
      name: Prowlarr Port
      port: 9696

    - <<: *tcp_defaults
      name: Jellyfin Port
      port: 8096

    - <<: *tcp_defaults
      name: Jellyseerr Port
      port: 5055

    - <<: *tcp_defaults
      name: Uptime Kuma Port
      port: 3001

############################
# HOME INFRA - ARR SENSORS
############################
# Requires secrets: sonarr_api_key, radarr_api_key, and the URL secrets below.

sensor:
    - &arr_rest_defaults
      platform: rest
      method: GET
      timeout: 8
      headers:
          X-Api-Key: !secret sonarr_api_key
      value_template: >-
          {{ value_json.totalRecords | default(0) | int }}
    # -------- Sonarr --------
    - <<: *arr_rest_defaults
      name: Sonarr Queue Count
      unique_id: home_infra_sonarr_queue_count
      resource: !secret sonarr_queue_url
      scan_interval: 300

    - <<: *arr_rest_defaults
      name: Sonarr Missing Episodes
      unique_id: home_infra_sonarr_missing_episodes
      resource: !secret sonarr_missing_url
      scan_interval: 900

    - <<: *arr_rest_defaults
      name: Sonarr Cutoff Unmet
      unique_id: home_infra_sonarr_cutoff_unmet
      resource: !secret sonarr_cutoff_url
      scan_interval: 1800

    # -------- Radarr --------
    - <<: *arr_rest_defaults
      name: Radarr Queue Count
      unique_id: home_infra_radarr_queue_count
      resource: !secret radarr_queue_url
      scan_interval: 300
      headers: &radarr_headers
          X-Api-Key: !secret radarr_api_key

    - <<: *arr_rest_defaults
      name: Radarr Missing Movies
      unique_id: home_infra_radarr_missing_movies
      resource: !secret radarr_missing_url
      scan_interval: 1800
      headers: *radarr_headers

############################
# HOME INFRA - DISK FREE (via SSH)
############################
# Requires secret: media_box_ssh_target (example: "user@192.168.1.154").

command_line:
    - sensor: &disk_free_common
          unit_of_measurement: 'GB'
          scan_interval: 300
          value_template: '{{ value | int(0) }}'

    - sensor:
          <<: *disk_free_common
          name: Downloads Free GB
          unique_id: home_infra_downloads_free_gb
          command: >-
              bash /config/scripts/disk_free.sh
              !secret media_box_ssh_target
              /srv/downloads

    - sensor:
          <<: *disk_free_common
          name: Media Free GB
          unique_id: home_infra_media_free_gb
          command: >-
              bash /config/scripts/disk_free.sh
              !secret media_box_ssh_target
              /srv/media

############################
# HOME INFRA - ALERT THRESHOLDS
############################

input_number:
    downloads_free_gb_warn:
        name: Downloads Free GB Warn
        min: 0
        max: 5000
        step: 1
        unit_of_measurement: 'GB'
        initial: 50

    media_free_gb_warn:
        name: Media Free GB Warn
        min: 0
        max: 5000
        step: 1
        unit_of_measurement: 'GB'
        initial: 100

############################
# HOME INFRA - AUTOMATIONS
############################

automation:
    - id: home_infra_gluetun_down
      alias: Home Infra - Gluetun Down
      mode: single
      trigger:
          - platform: state
            entity_id: binary_sensor.gluetun_vpn_health
            to:
                - 'off'
                - 'unavailable'
                - 'unknown'
            for:
                minutes: 2
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸ”´ **GLUETUN VPN DOWN**
                    Docker outbound blocked (kill-switch active).
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

    - id: home_infra_gluetun_restored
      alias: Home Infra - Gluetun Restored
      mode: single
      trigger:
          - platform: state
            entity_id: binary_sensor.gluetun_vpn_health
            to: 'on'
            for:
                seconds: 30
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸŸ¢ **GLUETUN VPN UP**
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

    - &queue_stuck_template
      id: home_infra_sonarr_queue_stuck
      alias: Home Infra - Sonarr Queue Stuck
      mode: single
      trigger:
          - platform: numeric_state
            entity_id: sensor.sonarr_queue_count
            above: 0
            for:
                minutes: 60
      action:
          - service: script.home_infra_queue_stuck_notify
            data:
                service_name: Sonarr
                queue_sensor: sensor.sonarr_queue_count
                missing_sensor: sensor.sonarr_missing_episodes

    - <<: *queue_stuck_template
      id: home_infra_radarr_queue_stuck
      alias: Home Infra - Radarr Queue Stuck
      trigger:
          - platform: numeric_state
            entity_id: sensor.radarr_queue_count
            above: 0
            for:
                minutes: 60
      action:
          - service: script.home_infra_queue_stuck_notify
            data:
                service_name: Radarr
                queue_sensor: sensor.radarr_queue_count
                missing_sensor: sensor.radarr_missing_movies

    - id: home_infra_downloads_low_disk
      alias: Home Infra - Downloads Low Disk
      mode: single
      trigger:
          - platform: template
            value_template: >-
                {{ states('sensor.downloads_free_gb')|int(0) > 0 and
                   states('sensor.downloads_free_gb')|int(0) <= states('input_number.downloads_free_gb_warn')|int(0) }}
            for:
                minutes: 10
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸ”´ **LOW DISK: /srv/downloads**
                    Free: {{ states('sensor.downloads_free_gb') }} GB
                    Threshold: {{ states('input_number.downloads_free_gb_warn') }} GB
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

    - id: home_infra_media_low_disk
      alias: Home Infra - Media Low Disk
      mode: single
      trigger:
          - platform: template
            value_template: >-
                {{ states('sensor.media_free_gb')|int(0) > 0 and
                   states('sensor.media_free_gb')|int(0) <= states('input_number.media_free_gb_warn')|int(0) }}
            for:
                minutes: 10
      action:
          - service: notify.home_infra_alerts_anthony_paddison_8006541880
            data:
                message: |-
                    ðŸ”´ **LOW DISK: /srv/media**
                    Free: {{ states('sensor.media_free_gb') }} GB
                    Threshold: {{ states('input_number.media_free_gb_warn') }} GB
                    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}

script:
    home_infra_queue_stuck_notify:
        alias: Home Infra - Queue Stuck Notify
        mode: queued
        fields:
            service_name:
                description: Service label for the message header.
            queue_sensor:
                description: Sensor entity_id for queue length.
            missing_sensor:
                description: Sensor entity_id for missing items.
        sequence:
            - service: notify.home_infra_alerts_anthony_paddison_8006541880
              data:
                  message: |-
                      ðŸŸ  **{{ service_name | upper }} QUEUE STUCK**
                      Queue: {{ states(queue_sensor) }}
                      Missing: {{ states(missing_sensor) }}
                      {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
